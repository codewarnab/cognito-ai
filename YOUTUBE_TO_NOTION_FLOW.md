# YouTube to Notion Tool Call Flow - Complete Diagram

## The Flow (Who Passes What to Whom)

```
┌──────────────────────────────────────────────────────────────────────────┐
│ 1. USER CLICKS "YouTube to Notion" BUTTON                                │
└────────────────────────────────┬─────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 2. WORKFLOW ORCHESTRATOR (youtubeToNotionWorkflow.ts)                   │
│    - Calls AI model with workflow system prompt                         │
│    - AI decides to use: youtubeToNotionAgent tool                       │
└────────────────────────────────┬─────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────────────┐
│ 3. AI SDK v5 (Vercel AI SDK)                                            │
│    - Receives tool call from AI model                                   │
│    - Creates tool-call part with:                                       │
│      {                                                                   │
│        type: "tool-call",                                               │
│        toolName: "youtubeToNotionAgent",                                │
│        toolCallId: "call_abc123xyz",  ← GENERATED BY AI SDK             │
│        args: { youtubeUrl, videoTitle }                                 │
│      }                                                                   │
└────────────────────────────────┬─────────────────────────────────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │                         │
                    ▼                         ▼
┌──────────────────────────────┐  ┌──────────────────────────────────────┐
│ 4A. TOOL EXECUTION PATH      │  │ 4B. UI RENDERING PATH                │
│ (Backend/Execution)          │  │ (Frontend/Visual)                    │
└──────────────────────────────┘  └──────────────────────────────────────┘
         │                                   │
         │                                   │
         ▼                                   ▼
┌──────────────────────────────┐  ┌──────────────────────────────────────┐
│ registryUtils.ts             │  │ ToolPartRenderer.tsx                 │
│ getAllTools()                │  │                                      │
│                              │  │ - Receives tool-call part            │
│ Returns wrapped execute:     │  │ - Extracts:                          │
│   execute: async (args) => { │  │   * toolCallId: "call_abc123xyz"    │
│     // ❌ NO CONTEXT HERE!   │  │   * toolName: "youtubeToNotionAgent"│
│     // Only gets 'args'      │  │   * state: "input-available"         │
│     tool.execute(args)       │  │                                      │
│   }                          │  │ - Creates ToolUIState object         │
└──────┬───────────────────────┘  └───────────┬──────────────────────────┘
       │                                      │
       ▼                                      ▼
┌──────────────────────────────┐  ┌──────────────────────────────────────┐
│ useYoutubeToNotionAgent.tsx  │  │ useYoutubeToNotionAgent.tsx          │
│ (Tool Registration)          │  │ (UI Registration)                    │
│                              │  │                                      │
│ registerTool({               │  │ registerToolUI(                      │
│   name: "...",               │  │   "youtubeToNotionAgent",            │
│   execute: async (           │  │   (state: ToolUIState) => {          │
│     { youtubeUrl, ... }      │  │     // ✅ HAS toolCallId!            │
│     // ❌ 2nd param?          │  │     const workflowId =               │
│   ) => {                     │  │       state.toolCallId ||            │
│                              │  │       `youtube-${Date.now()}`;       │
│     // THIS WAS THE BUG:     │  │                                      │
│     // Tried to get          │  │     return <Renderer                 │
│     //   { toolCallId }      │  │       workflowId={workflowId} />     │
│     // But it's undefined!   │  │   }                                  │
│   }                          │  │ )                                    │
│ })                           │  │                                      │
└──────┬───────────────────────┘  └───────────┬──────────────────────────┘
       │                                      │
       ▼                                      ▼
┌──────────────────────────────┐  ┌──────────────────────────────────────┐
│ Execute Function Runs:       │  │ ChainOfThoughtToolRenderer.tsx       │
│                              │  │                                      │
│ const workflowId =           │  │ const { workflowId } = props         │
│   `youtube-${Date.now()}`    │  │ // workflowId from state.toolCallId  │
│                              │  │                                      │
│ progressStore.startWorkflow  │  │ useEffect(() => {                    │
│   (workflowId)               │  │   progressStore.subscribe(() => {    │
│                              │  │     setSteps(                        │
│ // Adds progress updates:    │  │       progressStore.getAll()         │
│ progressStore.add({          │  │     )                                │
│   title: "Fetching..."       │  │   })                                 │
│ })                           │  │ }, [])                               │
│                              │  │                                      │
│ progressStore.update(...)    │  │ // ✅ Shows all updates!             │
└──────────────────────────────┘  └──────────────────────────────────────┘
```

## Why `toolCallId` Was Undefined

### The Signature Mismatch

**What I Initially Thought:**
```typescript
execute: async (args, context) => {
  const { toolCallId } = context; // ❌ Tried this
}
```

**What It Actually Is (from registryUtils.ts):**
```typescript
export interface ToolDefinition {
  execute: (
    args: any,
    abortSignal?: AbortSignal  // ← NOT a context object!
  ) => Promise<any>;
}
```

**The AI SDK v5 Tool Execution Wrapper:**
```typescript
// In registryUtils.ts - getAllTools()
execute: async (args: any) => {  // ← Only receives args!
  const result = await tool.execute(args, abortSignal);
  return result;
}
```

### Where `toolCallId` Actually Exists

`toolCallId` is **ONLY available in the UI rendering path**, not in the execution path:

```typescript
// ✅ AVAILABLE HERE (UI Path):
registerToolUI('youtubeToNotionAgent', (state: ToolUIState) => {
  console.log(state.toolCallId); // "call_abc123xyz"
  return <Component />;
});

// ❌ NOT AVAILABLE HERE (Execution Path):
registerTool({
  execute: async (args, abortSignal) => {
    // No toolCallId here!
  }
});
```

## The Solution

**Before (BROKEN):**
```typescript
// Execute path creates ID: "youtube-1732000001234"
const workflowId = `youtube-${Date.now()}`;
progressStore.startWorkflow(workflowId);

// UI path creates DIFFERENT ID: "youtube-1732000001235"
const workflowId = state.toolCallId || `youtube-${Date.now()}`;

// ❌ IDs don't match → UI shows nothing
```

**After (FIXED):**
```typescript
// Execute path creates unique ID
const workflowId = `youtube-${Date.now()}-${Math.random()}`;
progressStore.startWorkflow(workflowId);

// UI subscribes to ALL updates (no filtering needed)
useEffect(() => {
  progressStore.subscribe(() => {
    setSteps(progressStore.getAll()); // ✅ Get everything
  });
}, []);
```

## Key Insight

The `toolCallId` is **UI metadata** provided by the AI SDK for tracking tool calls in the conversation. It's **not passed to the tool's execute function** because:

1. **Execute function** is about **doing the work** (pure business logic)
2. **UI renderer** is about **showing progress** (presentation layer)
3. They communicate through the **progressStore** (shared state)

Since only **one YouTube to Notion workflow runs at a time**, we don't need to filter by workflow ID - the UI can just display whatever is in the progress store!
