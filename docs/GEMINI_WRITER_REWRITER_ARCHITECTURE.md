# Gemini Writer & Rewriter Architecture

## Overview

The Gemini Writer and Rewriter are two AI-powered text generation features in the Chrome extension that leverage Google's Gemini API. Both share similar architectural patterns but serve different use cases:

- **Writer**: Generates new content from scratch via `/write` command
- **Rewriter**: Transforms existing selected text with presets or custom instructions

---

## High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CONTENT SCRIPT LAYER                               â”‚
â”‚  (Runs in webpage context - src/contents/)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚     WRITER FEATURE          â”‚    â”‚     REWRITER FEATURE        â”‚            â”‚
â”‚  â”‚  write-command.tsx          â”‚    â”‚  text-rewriter.tsx          â”‚            â”‚
â”‚  â”‚                             â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚  â”‚  â”‚ useWriteCommandDetectionâ”‚ â”‚    â”‚  â”‚ useTextSelection      â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Detects /write cmd  â”‚  â”‚    â”‚  â”‚ - Context menu triggerâ”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Shadow DOM support  â”‚  â”‚    â”‚  â”‚ - Selection capture   â”‚  â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚  â”‚                             â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚  â”‚  â”‚ WriterOverlay.tsx     â”‚  â”‚    â”‚  â”‚ RewriterTooltip.tsx   â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Floating UI panel   â”‚  â”‚    â”‚  â”‚ - Floating tooltip    â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Prompt input        â”‚  â”‚    â”‚  â”‚ - Preset buttons      â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Attachment support  â”‚  â”‚    â”‚  â”‚ - Custom instruction  â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Tool toggles        â”‚  â”‚    â”‚  â”‚ - Tool toggles        â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Drag & drop         â”‚  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚                             â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”‚ useRewriter.ts        â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ useTextInsertion      â”‚  â”‚    â”‚  â”‚ - Port communication  â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Insert generated    â”‚  â”‚    â”‚  â”‚ - State management    â”‚  â”‚            â”‚
â”‚  â”‚  â”‚   text into field     â”‚  â”‚    â”‚  â”‚ - Selection replace   â”‚  â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                              â”‚
                    â”‚ chrome.runtime.connect()     â”‚ chrome.runtime.connect()
                    â”‚ Port: 'write-command'        â”‚ Port: 'text-rewriter'
                    â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           BACKGROUND SERVICE WORKER                             â”‚
â”‚  (src/background/)                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    MESSAGE ROUTER (messaging/router.ts)                  â”‚   â”‚
â”‚  â”‚  - initializeWriterPortListener()                                        â”‚   â”‚
â”‚  â”‚  - initializeRewriterPortListener()                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                              â”‚                             â”‚
â”‚                    â–¼                              â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   WRITER MODULE             â”‚    â”‚   REWRITER MODULE           â”‚            â”‚
â”‚  â”‚   (writer/)                 â”‚    â”‚   (rewriter/)               â”‚            â”‚
â”‚  â”‚                             â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚  â”‚  â”‚ handler.ts            â”‚  â”‚    â”‚  â”‚ handler.ts            â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - handleWriteGenerate â”‚  â”‚    â”‚  â”‚ - handleRewriteRequestâ”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Error handling      â”‚  â”‚    â”‚  â”‚ - Error handling      â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Port messaging      â”‚  â”‚    â”‚  â”‚ - Port messaging      â”‚  â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚  â”‚            â”‚                â”‚    â”‚            â”‚                â”‚            â”‚
â”‚  â”‚            â–¼                â”‚    â”‚            â–¼                â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚  â”‚  â”‚ geminiWriter.ts       â”‚  â”‚    â”‚  â”‚ geminiRewriter.ts     â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - GeminiWriter class  â”‚  â”‚    â”‚  â”‚ - GeminiRewriter classâ”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - generate()          â”‚  â”‚    â”‚  â”‚ - rewrite()           â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - generateStream()    â”‚  â”‚    â”‚  â”‚ - Non-streaming only  â”‚  â”‚            â”‚
â”‚  â”‚  â”‚ - Function calling    â”‚  â”‚    â”‚  â”‚ - Function calling    â”‚  â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚  â”‚            â”‚                â”‚    â”‚            â”‚                â”‚            â”‚
â”‚  â”‚            â–¼                â”‚    â”‚            â–¼                â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â”‚ contextBuilder.ts     â”‚  â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â”‚ - Platform detection  â”‚  â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â”‚ - Tone suggestions    â”‚  â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚            â”‚                â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚            â–¼                â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â”‚ streamParser.ts       â”‚  â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â”‚ - parseGeminiSSE()    â”‚  â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â”‚ - SSE chunk parsing   â”‚  â”‚    â”‚                             â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚                             â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                    â”‚                              â”‚                             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                   â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SUPERMEMORY MODULE (supermemory/)                     â”‚   â”‚
â”‚  â”‚  - searchMemories() - Semantic search in user's knowledge base           â”‚   â”‚
â”‚  â”‚  - getMemorySearchTool() - Function declaration for Gemini               â”‚   â”‚
â”‚  â”‚  - executeMemorySearch() - Execute AI-requested searches                 â”‚   â”‚
â”‚  â”‚  - formatMemoriesForPrompt() - Format results for context                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ HTTPS API Calls
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              EXTERNAL SERVICES                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   GOOGLE AI (Gemini API)    â”‚    â”‚   VERTEX AI                 â”‚            â”‚
â”‚  â”‚   - Primary provider        â”‚    â”‚   - Fallback provider       â”‚            â”‚
â”‚  â”‚   - API key auth            â”‚    â”‚   - Service account auth    â”‚            â”‚
â”‚  â”‚   - generativelanguage.     â”‚    â”‚   - {location}-aiplatform.  â”‚            â”‚
â”‚  â”‚     googleapis.com          â”‚    â”‚     googleapis.com          â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         GEMINI TOOLS (Optional)                          â”‚   â”‚
â”‚  â”‚  - url_context: Fetch and analyze URLs                                   â”‚   â”‚
â”‚  â”‚  - google_search: Real-time web search grounding                         â”‚   â”‚
â”‚  â”‚  - function_declarations: Custom function calling (memory search)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## Component Details

### 1. Writer Feature

#### Trigger Mechanism
- User types `/write` followed by a prompt in any editable field
- `useWriteCommandDetection` hook monitors input events
- Supports Shadow DOM, iframes, and contenteditable elements
- Command is removed from input after detection

#### UI Component (WriterOverlay)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‰¡  Writer                          âœ•  â”‚  â† Draggable header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Attachment Preview - if any]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [What would you like me to write?] ðŸ“Ž âž¤â”‚  â† Input + attach + send
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜ URL Context  â˜ Search  â˜ Memory     â”‚  â† Tool toggles
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚  â† Loading skeleton
â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Generated text appears here...         â”‚  â† Output area
â”‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Copy] [Regenerate] [Insert â–¶]         â”‚  â† Action buttons
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Features
- **Multimodal Support**: Images and PDFs via attachment
- **Platform Detection**: Gmail, LinkedIn, Twitter, Slack, etc.
- **Tone Customization**: Professional, casual, formal, friendly
- **Tool Integration**: URL context, Google Search, Supermemory
- **Streaming**: Real-time text generation display

### 2. Rewriter Feature

#### Trigger Mechanism
- User selects text on any webpage
- Right-click â†’ Context menu "Rewrite with Cognito AI"
- Background sends `SHOW_REWRITER` message to content script
- Tooltip appears near selection

#### UI Component (RewriterTooltip)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœŽ  Rewrite                         âœ•  â”‚  â† Header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Shorter][Expand][Professional]        â”‚  â† Preset buttons
â”‚ [Friendly][Improve][Simplify]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Custom instruction...]            âž¤   â”‚  â† Custom input
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜ URL Context  â˜ Search  â˜ Memory     â”‚  â† Tool toggles
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Rewritten text appears here...         â”‚  â† Output area
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Copy]                    [Apply âœ“]    â”‚  â† Action buttons
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Presets
| Preset | Description |
|--------|-------------|
| `shorter` | Condense while preserving meaning |
| `longer` | Expand with more detail |
| `professional` | Formal business tone |
| `casual` | Friendly, relaxed tone |
| `improve` | Fix grammar, clarity, flow |
| `simplify` | Easier to understand |
| `enthusiastic` | Positive, energetic tone |
| `conversational` | Natural speaking style |

---

## Data Flow Diagrams

### Writer Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User       â”‚     â”‚  Content     â”‚     â”‚  Background  â”‚     â”‚  Gemini API  â”‚
â”‚   Action     â”‚     â”‚  Script      â”‚     â”‚  Worker      â”‚     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ Type "/write       â”‚                    â”‚                    â”‚
       â”‚ draft email"       â”‚                    â”‚                    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ Detect command     â”‚                    â”‚
       â”‚                    â”‚ Remove from input  â”‚                    â”‚
       â”‚                    â”‚ Show WriterOverlay â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ Enter prompt       â”‚                    â”‚                    â”‚
       â”‚ + attachments      â”‚                    â”‚                    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ Connect port       â”‚                    â”‚
       â”‚                    â”‚ 'write-command'    â”‚                    â”‚
       â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ WRITE_GENERATE     â”‚                    â”‚
       â”‚                    â”‚ {prompt, context,  â”‚                    â”‚
       â”‚                    â”‚  settings, attach} â”‚                    â”‚
       â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ Build system promptâ”‚
       â”‚                    â”‚                    â”‚ Get provider info  â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ POST /generateContent
       â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚    [If function call]
       â”‚                    â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ Execute memory     â”‚
       â”‚                    â”‚                    â”‚ search             â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ POST with function â”‚
       â”‚                    â”‚                    â”‚ response           â”‚
       â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚    Generated text  â”‚
       â”‚                    â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ WRITE_STREAM_CHUNK â”‚                    â”‚
       â”‚                    â”‚ {text, done}       â”‚                    â”‚
       â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ Display text       â”‚                    â”‚                    â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ Click "Insert"     â”‚                    â”‚                    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ Insert into field  â”‚                    â”‚
       â”‚                    â”‚ Close overlay      â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â–¼                    â–¼                    â–¼                    â–¼
```


### Rewriter Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User       â”‚     â”‚  Content     â”‚     â”‚  Background  â”‚     â”‚  Gemini API  â”‚
â”‚   Action     â”‚     â”‚  Script      â”‚     â”‚  Worker      â”‚     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ Select text        â”‚                    â”‚                    â”‚
       â”‚ Right-click        â”‚                    â”‚                    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ Context menu click â”‚
       â”‚                    â”‚                    â”‚ SHOW_REWRITER msg  â”‚
       â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ Capture selection  â”‚                    â”‚
       â”‚                    â”‚ Show RewriterTooltip                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ Click preset       â”‚                    â”‚                    â”‚
       â”‚ (e.g., "Shorter")  â”‚                    â”‚                    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ Connect port       â”‚                    â”‚
       â”‚                    â”‚ 'text-rewriter'    â”‚                    â”‚
       â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ REWRITE_REQUEST    â”‚                    â”‚
       â”‚                    â”‚ {text, preset,     â”‚                    â”‚
       â”‚                    â”‚  toolSettings}     â”‚                    â”‚
       â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ Build rewrite prompt
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ POST /generateContent
       â”‚                    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚    Rewritten text  â”‚
       â”‚                    â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ REWRITE_COMPLETE   â”‚                    â”‚
       â”‚                    â”‚ {text}             â”‚                    â”‚
       â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ Display result     â”‚                    â”‚                    â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ Click "Apply"      â”‚                    â”‚                    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ Replace selection  â”‚                    â”‚
       â”‚                    â”‚ (execCommand or    â”‚                    â”‚
       â”‚                    â”‚  DOM manipulation) â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â–¼                    â–¼                    â–¼                    â–¼
```

---

## Core Classes

### GeminiWriter Class

```typescript
class GeminiWriter {
    private model = 'gemini-2.5-flash-lite';
    
    // Provider selection (Google AI preferred, Vertex AI fallback)
    private async getProviderInfo(streaming?: boolean): Promise<ProviderInfo>;
    
    // Build context-aware system prompt
    private buildSystemPrompt(options?: WriterOptions): string;
    
    // Build multimodal request parts (attachments + text)
    private buildRequestParts(prompt: string, options?: WriterOptions): GeminiRequestPart[];
    
    // Non-streaming generation with function calling loop
    async generate(prompt: string, options?: WriterOptions): Promise<string>;
    
    // Streaming generation (SSE)
    async *generateStream(prompt: string, options?: WriterOptions): AsyncGenerator<string>;
}
```

### GeminiRewriter Class

```typescript
class GeminiRewriter {
    private model = 'gemini-2.5-flash-lite';
    
    // Provider selection
    private async getProviderInfo(): Promise<ProviderInfo>;
    
    // Non-streaming rewrite with function calling loop
    async rewrite(text: string, options?: RewriterOptions): Promise<string>;
}
```

---

## Tool Integration

### Available Tools

| Tool | Description | API Parameter |
|------|-------------|---------------|
| URL Context | Fetch and analyze web pages | `{ url_context: {} }` |
| Google Search | Real-time web search grounding | `{ google_search: {} }` |
| Memory Search | Search user's Supermemory knowledge base | `{ function_declarations: [...] }` |

### Tool Limitation

**Important**: Gemini API cannot mix built-in tools (`url_context`, `google_search`) with function calling in the same request.

**Solution**:
- If built-in tools enabled â†’ Pre-search memories and inject into prompt
- If no built-in tools â†’ Use function calling loop for AI-driven memory search

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TOOL SELECTION LOGIC                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  enableSupermemorySearch = true?                                â”‚
â”‚           â”‚                                                     â”‚
â”‚           â”œâ”€â”€ YES â”€â”€â–º hasBuiltInTools (URL/Search)?             â”‚
â”‚           â”‚                    â”‚                                â”‚
â”‚           â”‚                    â”œâ”€â”€ YES â”€â”€â–º PRE-SEARCH MODE      â”‚
â”‚           â”‚                    â”‚           Search memories first â”‚
â”‚           â”‚                    â”‚           Add to prompt context â”‚
â”‚           â”‚                    â”‚           Use built-in tools   â”‚
â”‚           â”‚                    â”‚                                â”‚
â”‚           â”‚                    â””â”€â”€ NO â”€â”€â”€â–º FUNCTION CALLING MODEâ”‚
â”‚           â”‚                                AI decides when to   â”‚
â”‚           â”‚                                search memories      â”‚
â”‚           â”‚                                Loop up to 3 calls   â”‚
â”‚           â”‚                                                     â”‚
â”‚           â””â”€â”€ NO â”€â”€â”€â–º Standard generation (no memory)           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## Function Calling Loop (Memory Search)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FUNCTION CALLING LOOP (Max 3 iterations)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚  â”‚ User Prompt â”‚                                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Initial Request to Gemini                                            â”‚   â”‚
â”‚  â”‚ - System prompt + user prompt                                        â”‚   â”‚
â”‚  â”‚ - Tools: [function_declarations: search_memories]                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                                           â”‚
â”‚                                 â–¼                                           â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚ Response has           â”‚                               â”‚
â”‚                    â”‚ functionCall?          â”‚                               â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                â”‚                                            â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â”‚ YES                               â”‚ NO                       â”‚
â”‚              â–¼                                   â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Extract function call     â”‚      â”‚ Extract text response     â”‚          â”‚
â”‚  â”‚ name: "search_memories"   â”‚      â”‚ Return to user            â”‚          â”‚
â”‚  â”‚ args: {query, limit}      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚                â”‚                                                            â”‚
â”‚                â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚  â”‚ executeMemorySearch()     â”‚                                              â”‚
â”‚  â”‚ - Call Supermemory API    â”‚                                              â”‚
â”‚  â”‚ - Format results          â”‚                                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚                â”‚                                                            â”‚
â”‚                â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Add to conversation:                                                   â”‚ â”‚
â”‚  â”‚ 1. Model's function call (role: model)                                 â”‚ â”‚
â”‚  â”‚ 2. Function response with results (role: user, functionResponse)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                â”‚                                                            â”‚
â”‚                â”‚ Loop back (increment counter)                              â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Memory Search Function Declaration

```typescript
const MEMORY_SEARCH_FUNCTION = {
    name: 'search_memories',
    description: `Search the user's personal knowledge base for relevant information...`,
    parameters: {
        type: 'object',
        properties: {
            query: {
                type: 'string',
                description: 'The search query to find relevant memories.'
            },
            limit: {
                type: 'number',
                description: 'Maximum results (1-10). Default: 5.'
            }
        },
        required: ['query']
    }
};
```

---

## Platform Detection (Writer)

The Writer uses intelligent platform detection to customize prompts:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PLATFORM DETECTION                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  URL Pattern              Platform        Suggested Tone        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  mail.google.com          Gmail           professional          â”‚
â”‚  outlook.live.com         Outlook         professional          â”‚
â”‚  linkedin.com             LinkedIn        professional          â”‚
â”‚  twitter.com / x.com      Twitter         casual                â”‚
â”‚  github.com               GitHub          professional          â”‚
â”‚  slack.com                Slack           casual                â”‚
â”‚  discord.com              Discord         casual                â”‚
â”‚  notion.so                Notion          professional          â”‚
â”‚  docs.google.com          Google Docs     professional          â”‚
â”‚  medium.com               Medium          professional          â”‚
â”‚  *                        Web (default)   professional          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling

### Error Codes

| Code | Description | User Message |
|------|-------------|--------------|
| `NO_API_KEY` | No API key configured | "Please configure your API key in settings" |
| `RATE_LIMITED` | 429 response | "Too many requests. Please wait..." |
| `NETWORK_ERROR` | Connection failed | "Network error. Check your connection" |
| `INVALID_RESPONSE` | Malformed API response | "Invalid response from AI service" |
| `PORT_DISCONNECTED` | Chrome port closed | "Connection lost. Please try again" |
| `WRITE_FAILED` / `REWRITE_FAILED` | Generic failure | Error message or "Unexpected error" |

### Error Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ERROR HANDLING FLOW                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  try {                                                          â”‚
â”‚      const response = await fetch(geminiUrl, options);          â”‚
â”‚                                                                 â”‚
â”‚      if (!response.ok) {                                        â”‚
â”‚          // Parse status code â†’ map to error code               â”‚
â”‚          // 401/403 â†’ NO_API_KEY                                â”‚
â”‚          // 429 â†’ RATE_LIMITED                                  â”‚
â”‚          // 5xx â†’ Service unavailable                           â”‚
â”‚          throw new Error(`API error: ${status}`);               â”‚
â”‚      }                                                          â”‚
â”‚                                                                 â”‚
â”‚      // Process response...                                     â”‚
â”‚                                                                 â”‚
â”‚  } catch (error) {                                              â”‚
â”‚      const { message, code } = getErrorDetails(error);          â”‚
â”‚                                                                 â”‚
â”‚      if (isPortConnected) {                                     â”‚
â”‚          port.postMessage({                                     â”‚
â”‚              action: 'WRITE_ERROR' | 'REWRITE_ERROR',           â”‚
â”‚              error: message,  // User-friendly                  â”‚
â”‚              code: code       // For programmatic handling      â”‚
â”‚          });                                                    â”‚
â”‚      }                                                          â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## Message Types

### Writer Messages

```typescript
// Request (Content â†’ Background)
interface WriteGenerateRequest {
    action: 'WRITE_GENERATE';
    payload: {
        prompt: string;
        pageContext?: WritePageContext;
        settings?: {
            tone?: WriteTone;
            maxTokens?: number;
            enableUrlContext?: boolean;
            enableGoogleSearch?: boolean;
            enableSupermemorySearch?: boolean;
        };
        attachment?: WriteAttachmentPayload;
    };
}

// Response chunk (Background â†’ Content)
interface WriteStreamChunk {
    action: 'WRITE_STREAM_CHUNK';
    text: string;
    done: boolean;
}

// Error (Background â†’ Content)
interface WriteError {
    action: 'WRITE_ERROR';
    error: string;
    code?: string;
}
```

### Rewriter Messages

```typescript
// Request (Content â†’ Background)
interface RewriteRequest {
    action: 'REWRITE_REQUEST';
    payload: {
        selectedText: string;
        instruction: string;
        preset?: RewritePreset;
        enableUrlContext?: boolean;
        enableGoogleSearch?: boolean;
        enableSupermemorySearch?: boolean;
    };
}

// Response (Background â†’ Content)
interface RewriteResponse {
    action: 'REWRITE_COMPLETE';
    text: string;
}

// Error (Background â†’ Content)
interface RewriteError {
    action: 'REWRITE_ERROR';
    error: string;
    code?: string;
}
```

---

## Port Communication

Both features use Chrome's `runtime.connect()` for reliable bidirectional messaging:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PORT LIFECYCLE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Content Script                    Background Worker            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                                                 â”‚
â”‚  const port = chrome.runtime       chrome.runtime.onConnect     â”‚
â”‚    .connect({                        .addListener((port) => {   â”‚
â”‚      name: 'write-command'           if (port.name === '...') { â”‚
â”‚    });                                 // Handle messages       â”‚
â”‚                                      }                          â”‚
â”‚  port.onMessage.addListener(...)   });                          â”‚
â”‚                                                                 â”‚
â”‚  port.postMessage({                port.postMessage({           â”‚
â”‚    action: 'WRITE_GENERATE',         action: 'WRITE_STREAM_CHUNK'
â”‚    payload: {...}                    text: '...',               â”‚
â”‚  });                                 done: false                â”‚
â”‚                                    });                          â”‚
â”‚                                                                 â”‚
â”‚  port.onDisconnect.addListener     port.onDisconnect.addListenerâ”‚
â”‚    (() => {                          (() => {                   â”‚
â”‚      // Cleanup                        // Cleanup               â”‚
â”‚    });                               });                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Structure

```
src/
â”œâ”€â”€ background/
â”‚   â”œâ”€â”€ writer/
â”‚   â”‚   â”œâ”€â”€ index.ts              # Exports
â”‚   â”‚   â”œâ”€â”€ geminiWriter.ts       # GeminiWriter class
â”‚   â”‚   â”œâ”€â”€ handler.ts            # handleWriteGenerate()
â”‚   â”‚   â”œâ”€â”€ contextBuilder.ts     # Platform detection, tone
â”‚   â”‚   â””â”€â”€ streamParser.ts       # SSE parsing utilities
â”‚   â”‚
â”‚   â”œâ”€â”€ rewriter/
â”‚   â”‚   â”œâ”€â”€ index.ts              # Exports
â”‚   â”‚   â”œâ”€â”€ geminiRewriter.ts     # GeminiRewriter class
â”‚   â”‚   â””â”€â”€ handler.ts            # handleRewriteRequest()
â”‚   â”‚
â”‚   â”œâ”€â”€ supermemory/
â”‚   â”‚   â”œâ”€â”€ index.ts              # Exports
â”‚   â”‚   â”œâ”€â”€ searchService.ts      # searchMemories()
â”‚   â”‚   â”œâ”€â”€ functionDeclaration.ts # MEMORY_SEARCH_FUNCTION
â”‚   â”‚   â””â”€â”€ functionHandler.ts    # Function calling utilities
â”‚   â”‚
â”‚   â”œâ”€â”€ contextMenu/
â”‚   â”‚   â””â”€â”€ rewriterContextMenu.ts # Right-click menu setup
â”‚   â”‚
â”‚   â””â”€â”€ messaging/
â”‚       â””â”€â”€ router.ts             # Port listeners initialization
â”‚
â”œâ”€â”€ contents/
â”‚   â”œâ”€â”€ write-command.tsx         # Writer content script entry
â”‚   â”œâ”€â”€ write-command/
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ WriterOverlay.tsx     # Main UI component
â”‚   â”‚   â”œâ”€â”€ WritingAnimation.tsx  # Loading skeleton
â”‚   â”‚   â”œâ”€â”€ WriterAttachmentPreview.tsx
â”‚   â”‚   â”œâ”€â”€ useWriteCommandDetection.ts
â”‚   â”‚   â”œâ”€â”€ useTextInsertion.ts
â”‚   â”‚   â”œâ”€â”€ useWriterAttachment.ts
â”‚   â”‚   â”œâ”€â”€ writerAttachmentUtils.ts
â”‚   â”‚   â”œâ”€â”€ platformDetector.ts
â”‚   â”‚   â””â”€â”€ ErrorBoundary.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ text-rewriter.tsx         # Rewriter content script entry
â”‚   â”œâ”€â”€ text-rewriter/
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ RewriterTooltip.tsx   # Main UI component
â”‚   â”‚   â”œâ”€â”€ RewriterPresets.tsx   # Preset buttons
â”‚   â”‚   â”œâ”€â”€ useRewriter.ts        # Port communication hook
â”‚   â”‚   â””â”€â”€ useTextRewriterSelection.ts
â”‚   â”‚
â”‚   â””â”€â”€ shared/
â”‚       â””â”€â”€ ToolsToggle.tsx       # Shared tool settings UI
â”‚
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ writeCommand.ts           # Writer type definitions
â”‚   â””â”€â”€ rewriteCommand.ts         # Rewriter type definitions
â”‚
â”œâ”€â”€ utils/settings/
â”‚   â”œâ”€â”€ writeCommandSettings.ts   # Writer settings storage
â”‚   â””â”€â”€ rewriteSettings.ts        # Rewriter settings storage
â”‚
â””â”€â”€ styles/features/
    â”œâ”€â”€ write-command.css         # Writer styles
    â””â”€â”€ text-rewriter.css         # Rewriter styles
```

---

## Configuration & Settings

### Writer Settings

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `enabled` | boolean | true | Feature toggle |
| `defaultTone` | WriteTone | 'professional' | Default writing tone |
| `maxOutputTokens` | number | 1024 | Max generation length |
| `includePageContext` | boolean | true | Send page info to AI |
| `enableUrlContext` | boolean | false | URL analysis tool |
| `enableGoogleSearch` | boolean | false | Web search grounding |
| `enableSupermemorySearch` | boolean | false | Memory search |

### Rewriter Settings

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `enabled` | boolean | true | Feature toggle |
| `enableUrlContext` | boolean | false | URL analysis tool |
| `enableGoogleSearch` | boolean | false | Web search grounding |
| `enableSupermemorySearch` | boolean | false | Memory search |

---

## Security Considerations

1. **API Key Protection**: Keys stored in Chrome storage, never logged
2. **No PII Logging**: Error objects sanitized before logging
3. **Content Script Isolation**: Runs in isolated world, uses Shadow DOM
4. **Port Validation**: Check `chrome.runtime.id` before operations
5. **Input Sanitization**: User prompts passed directly to API (Gemini handles)

---

## Performance Optimizations

1. **Singleton Instances**: `geminiWriter` and `geminiRewriter` are singletons
2. **Port Reuse**: Single port per operation, cleaned up on completion
3. **Debounced Detection**: 200ms debounce on `/write` command detection
4. **Lazy Tool Loading**: Tools only added to request when enabled
5. **Pre-search vs Function Calling**: Avoids multiple API round-trips when possible


---

## Complete System Block Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         BROWSER TAB                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                    WEB PAGE (any URL)                                          â”‚ â”‚
â”‚  â”‚                                                                                                â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚   â”‚                              PLASMO SHADOW DOM                                           â”‚ â”‚ â”‚
â”‚  â”‚   â”‚                                                                                          â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚      WRITER OVERLAY         â”‚      â”‚     REWRITER TOOLTIP        â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚                             â”‚      â”‚                             â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â”‚ Prompt Input          â”‚  â”‚      â”‚  â”‚ Preset Buttons        â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â”‚ [________________] ðŸ“Žâž¤â”‚  â”‚      â”‚  â”‚ [S][E][P][F][I][Si]   â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚                             â”‚      â”‚                             â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â”‚ Tool Toggles          â”‚  â”‚      â”‚  â”‚ Custom Instruction    â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â”‚ â˜URL â˜Search â˜Memory  â”‚  â”‚      â”‚  â”‚ [________________] âž¤  â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚                             â”‚      â”‚                             â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â”‚ Generated Output      â”‚  â”‚      â”‚  â”‚ Rewritten Output      â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â”‚ Lorem ipsum dolor...  â”‚  â”‚      â”‚  â”‚ Improved text here... â”‚  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚                             â”‚      â”‚                             â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â”‚  [Copy][Regen][Insert â–¶]   â”‚      â”‚  [Copy]        [Apply âœ“]   â”‚                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”‚ â”‚
â”‚  â”‚   â”‚                                                                                          â”‚ â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                                                â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚   â”‚                              CONTENT SCRIPTS                                            â”‚  â”‚ â”‚
â”‚  â”‚   â”‚                                                                                         â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   write-command.tsx                        text-rewriter.tsx                            â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ useWriteCommandDetection()           â”œâ”€â”€ useRewriter()                            â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ Monitors input events            â”‚   â””â”€â”€ Port communication                   â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ Detects /write pattern           â”‚   â””â”€â”€ State management                     â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ Shadow DOM support               â”‚                                            â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   â”‚                                        â”œâ”€â”€ Context menu listener                    â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ useTextInsertion()                   â”‚   â””â”€â”€ SHOW_REWRITER message               â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ execCommand fallback             â”‚                                            â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ DOM manipulation                 â”œâ”€â”€ replaceSelection()                       â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   â”‚                                        â”‚   â””â”€â”€ execCommand / DOM                    â”‚  â”‚ â”‚
â”‚  â”‚   â”‚   â””â”€â”€ useWriterAttachment()                â”‚                                            â”‚  â”‚ â”‚
â”‚  â”‚   â”‚       â””â”€â”€ File processing                  â””â”€â”€ Selection capture                        â”‚  â”‚ â”‚
â”‚  â”‚   â”‚       â””â”€â”€ Base64 encoding                                                               â”‚  â”‚ â”‚
â”‚  â”‚   â”‚                                                                                         â”‚  â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â”‚                                                     â”‚
â”‚                                              â”‚ chrome.runtime.connect()                            â”‚
â”‚                                              â”‚ Ports: 'write-command', 'text-rewriter'             â”‚
â”‚                                              â–¼                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    BACKGROUND SERVICE WORKER                                        â”‚
â”‚                                                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                    MESSAGE ROUTER                                            â”‚  â”‚
â”‚   â”‚                                  (messaging/router.ts)                                       â”‚  â”‚
â”‚   â”‚                                                                                              â”‚  â”‚
â”‚   â”‚   initializeWriterPortListener()              initializeRewriterPortListener()               â”‚  â”‚
â”‚   â”‚   â””â”€â”€ Port: 'write-command'                   â””â”€â”€ Port: 'text-rewriter'                      â”‚  â”‚
â”‚   â”‚   â””â”€â”€ Action: WRITE_GENERATE                  â””â”€â”€ Action: REWRITE_REQUEST                    â”‚  â”‚
â”‚   â”‚                                                                                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                        â”‚                                â”‚
â”‚                          â–¼                                        â–¼                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚           WRITER MODULE              â”‚    â”‚          REWRITER MODULE             â”‚            â”‚
â”‚   â”‚                                      â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚   handler.ts                         â”‚    â”‚   handler.ts                         â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ handleWriteGenerate()          â”‚    â”‚   â”œâ”€â”€ handleRewriteRequest()         â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ getErrorDetails()              â”‚    â”‚   â”œâ”€â”€ getErrorDetails()              â”‚            â”‚
â”‚   â”‚   â””â”€â”€ Port message handling          â”‚    â”‚   â””â”€â”€ Port message handling          â”‚            â”‚
â”‚   â”‚              â”‚                       â”‚    â”‚              â”‚                       â”‚            â”‚
â”‚   â”‚              â–¼                       â”‚    â”‚              â–¼                       â”‚            â”‚
â”‚   â”‚   geminiWriter.ts                    â”‚    â”‚   geminiRewriter.ts                  â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ GeminiWriter class             â”‚    â”‚   â”œâ”€â”€ GeminiRewriter class           â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ generate() - non-streaming     â”‚    â”‚   â”œâ”€â”€ rewrite() - non-streaming      â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ generateStream() - SSE         â”‚    â”‚   â”œâ”€â”€ PRESET_PROMPTS mapping         â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ buildSystemPrompt()            â”‚    â”‚   â””â”€â”€ Function calling loop          â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ buildRequestParts()            â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚   â””â”€â”€ Function calling loop          â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚              â”‚                       â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚              â–¼                       â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚   contextBuilder.ts                  â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ detectPlatform()               â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ PLATFORM_PATTERNS              â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚   â””â”€â”€ buildPageContext()             â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚              â”‚                       â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚              â–¼                       â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚   streamParser.ts                    â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ parseGeminiSSE()               â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚   â”œâ”€â”€ parseSSELine()                 â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚   â””â”€â”€ collectGeminiSSE()             â”‚    â”‚                                      â”‚            â”‚
â”‚   â”‚                                      â”‚    â”‚                                      â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                          â”‚                                        â”‚                                â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                               â”‚                                                    â”‚
â”‚                                               â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                   SUPERMEMORY MODULE                                         â”‚  â”‚
â”‚   â”‚                                                                                              â”‚  â”‚
â”‚   â”‚   searchService.ts                    functionDeclaration.ts      functionHandler.ts         â”‚  â”‚
â”‚   â”‚   â”œâ”€â”€ searchMemories()                â”œâ”€â”€ MEMORY_SEARCH_FUNCTION  â”œâ”€â”€ hasFunctionCall()      â”‚  â”‚
â”‚   â”‚   â”œâ”€â”€ formatMemoriesForPrompt()       â”œâ”€â”€ parseMemorySearchParams â”œâ”€â”€ extractFunctionCall()  â”‚  â”‚
â”‚   â”‚   â””â”€â”€ isMemorySearchAvailable()       â””â”€â”€ MemorySearchFunctionParams                         â”‚  â”‚
â”‚   â”‚                                                                   â”œâ”€â”€ executeMemorySearch()  â”‚  â”‚
â”‚   â”‚                                                                   â””â”€â”€ getMemorySearchTool()  â”‚  â”‚
â”‚   â”‚                                                                                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                               â”‚                                                    â”‚
â”‚                                               â”‚                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                   PROVIDER SELECTION                                         â”‚  â”‚
â”‚   â”‚                                                                                              â”‚  â”‚
â”‚   â”‚   getProviderInfo()                                                                          â”‚  â”‚
â”‚   â”‚   â”œâ”€â”€ Check hasGoogleApiKey() â”€â”€â–º YES â”€â”€â–º Google AI (Gemini API)                             â”‚  â”‚
â”‚   â”‚   â”‚                                       generativelanguage.googleapis.com                  â”‚  â”‚
â”‚   â”‚   â”‚                                                                                          â”‚  â”‚
â”‚   â”‚   â””â”€â”€ Check hasVertexCredentials() â”€â”€â–º YES â”€â”€â–º Vertex AI                                     â”‚  â”‚
â”‚   â”‚                                               {location}-aiplatform.googleapis.com           â”‚  â”‚
â”‚   â”‚                                                                                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â”‚ HTTPS
                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      GOOGLE CLOUD SERVICES                                          â”‚
â”‚                                                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚         GOOGLE AI (Gemini API)       â”‚    â”‚            VERTEX AI                 â”‚             â”‚
â”‚   â”‚                                      â”‚    â”‚                                      â”‚             â”‚
â”‚   â”‚   Endpoint:                          â”‚    â”‚   Endpoint:                          â”‚             â”‚
â”‚   â”‚   generativelanguage.googleapis.com  â”‚    â”‚   {location}-aiplatform.googleapis.com             â”‚
â”‚   â”‚   /v1beta/models/{model}:            â”‚    â”‚   /v1/projects/{project}/locations/  â”‚             â”‚
â”‚   â”‚     generateContent                  â”‚    â”‚   {location}/publishers/google/      â”‚             â”‚
â”‚   â”‚     streamGenerateContent            â”‚    â”‚   models/{model}:generateContent     â”‚             â”‚
â”‚   â”‚                                      â”‚    â”‚                                      â”‚             â”‚
â”‚   â”‚   Auth: API Key (query param)        â”‚    â”‚   Auth: Bearer token (header)        â”‚             â”‚
â”‚   â”‚                                      â”‚    â”‚                                      â”‚             â”‚
â”‚   â”‚   Model: gemini-2.0-flash-lite       â”‚    â”‚   Model: gemini-2.0-flash-lite       â”‚             â”‚
â”‚   â”‚                                      â”‚    â”‚                                      â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                    GEMINI TOOLS                                              â”‚  â”‚
â”‚   â”‚                                                                                              â”‚  â”‚
â”‚   â”‚   Built-in Tools (cannot mix with function calling):                                         â”‚  â”‚
â”‚   â”‚   â”œâ”€â”€ url_context: {} â”€â”€â–º Fetch and analyze web page content                                 â”‚  â”‚
â”‚   â”‚   â””â”€â”€ google_search: {} â”€â”€â–º Real-time web search for grounding                               â”‚  â”‚
â”‚   â”‚                                                                                              â”‚  â”‚
â”‚   â”‚   Function Calling (custom tools):                                                           â”‚  â”‚
â”‚   â”‚   â””â”€â”€ function_declarations: [search_memories] â”€â”€â–º AI-driven memory search                   â”‚  â”‚
â”‚   â”‚                                                                                              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

The Gemini Writer and Rewriter are sophisticated AI-powered text generation features that:

1. **Share Common Infrastructure**: Both use the same provider selection, error handling, and Supermemory integration patterns
2. **Differ in Trigger & Purpose**: Writer generates new content via `/write` command; Rewriter transforms selected text via context menu
3. **Support Multiple Tools**: URL context, Google Search, and AI-driven memory search
4. **Handle Edge Cases**: Shadow DOM, iframes, rich text editors, network failures
5. **Prioritize UX**: Streaming output, loading states, error recovery, clipboard fallbacks
