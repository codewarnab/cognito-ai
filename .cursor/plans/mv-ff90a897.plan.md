<!-- ff90a897-22f6-4b48-a52d-bf4aaa3001cd 3d00d6ae-c158-4ddb-85b9-f58859ad5613 -->
# MV3 Permissions & Plasmo Manifest — Implementation Plan

### Goals

- Add only the required MV3 permissions and `<all_urls>` host permissions via the Plasmo `manifest` field in `package.json`.
- Cross-check each permission against the implemented features and document least-privilege rationale.
- Verify the generated `build/.../manifest.json` contains exactly the intended permissions and no more.

### Files to change

- `package.json` (Plasmo `manifest` field only)

### Exact manifest edits (in package.json)

Edit the existing `manifest` field to the following (replace, not merge):

```json
{
  "manifest": {
    "permissions": [
      "storage",
      "offscreen",
      "unlimitedStorage",
      "scripting",
      "alarms",
      "tabs"
    ],
    "host_permissions": [
      "<all_urls>"
    ]
  }
}
```

Notes:

- Keep the MV3 service worker in `src/background.ts` (Plasmo already maps it). No extra fields are required in the `manifest` here.
- Do not add any other permissions or optional permissions at this time.

### Permission–Feature rationale (least privilege)

| Permission | Why it is needed | Where it is used | Least-privilege note |

|---|---|---|---|

| storage | Persist small flags/settings (e.g., `modelVersion`, pause flags) in `chrome.storage.local`. | `src/background.ts`, future `src/pages/history.tsx` UI, settings. | Only `chrome.storage.local` is used; no sync use. |

| offscreen | Create offscreen document to host a `Worker` for embeddings without visible UI. | `src/background/offscreen.ts`, `src/offscreen/index.html`. | Offscreen is created on-demand and closed when idle. |

| unlimitedStorage | Allow large IndexedDB/Cache Storage for models and embeddings. | Worker and background writing to IndexedDB/Cache Storage. | Required for large local data; no network usage. |

| scripting | Programmatic injection for future capture or script execution where needed. | Background scheduling minor extraction or one-off scripts. | Used narrowly; no blanket content script matches expanded here. |

| alarms | Schedule background batching (queue coalescing, idle processing). | `src/background.ts` queue/scheduler. | Alarms are low-privilege; namespaced and cleared on uninstall/update. |

| tabs | Read basic tab info, open internal pages (history UI), manage lifecycle. | `src/popup.tsx` → open history page; background tab coordination. | Limit usage to required fields (`url`, `title` when needed). |

| host_permissions: `<all_urls>` | Allow content scripts/messages to operate on all sites for on-device capture. | `src/contents/extract.ts` (planned), messaging to background. | Can be tightened later (allowlist/denylist UI); surfaced to user with pause. |

### Security considerations

- No optional or additional permissions beyond the list above.
- All heavy work (model load/embeddings) runs locally; no network calls except first-run model download (handled separately, not expanding permissions).
- Prefer `IndexedDB`/Cache Storage and `chrome.storage.local` for small flags; avoid `storage.sync`.
- Offscreen document is created just-in-time and destroyed when idle; background service worker remains MV3-compliant.
- Future hardening: narrow `host_permissions` with domain controls once UI allow/deny lists are available.

### Validation steps (Chrome + local build)

1. Build the extension: `pnpm build`.
2. Open Chrome → `chrome://extensions` → enable Developer mode → Load unpacked → select `build/chrome-mv3-dev`.
3. Open the generated manifest viewer (click the extension → Details → View manifest) and confirm:

   - `manifest_version: 3`.
   - `permissions` contains exactly: `storage`, `offscreen`, `unlimitedStorage`, `scripting`, `alarms`, `tabs`.
   - `host_permissions` contains exactly: `<all_urls>`.
   - Background shows a Service Worker.

4. Open “Service worker” → Inspect. In the console, programmatically test (read-only checks):

   - `chrome.storage.local.get` returns (no errors).
   - `chrome.alarms.create("test-perm", { delayInMinutes: 1 })` succeeds and `chrome.alarms.onAlarm.addListener` fires.
   - `chrome.offscreen.hasDocument()` runs; creating is blocked unless implemented, but permission check shows no error when calling API.
   - `chrome.scripting.getRegisteredContentScripts()` returns (no permission error).
   - `chrome.tabs.query({ active: true, currentWindow: true })` returns (no permission error).

5. Confirm no runtime errors about missing permissions in the console.

### Acceptance criteria

- `package.json` contains the exact `manifest.permissions` and `manifest.host_permissions` shown above and nothing else.
- `build/.../manifest.json` includes the same permissions/host permissions, and the background is a MV3 service worker (not a persistent background page).
- Loading the unpacked build shows no permission warnings beyond the declared set; all permission API smoke tests above run without permission errors.
- No additional permissions (optional or required) are introduced.
- Rationale documented in this plan and kept alongside the codebase (can be copied to `docs/permissions.md` later without changes).

### To-dos

- [ ] Update package.json Plasmo manifest with required permissions
- [ ] Build and verify generated manifest.json matches required list
- [ ] Run Chrome console permission smoke tests for APIs
- [ ] Commit this rationale into docs/permissions.md for future audits